<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>记录一次ES修改mapping</title>
    <url>/2020/06/07/es-change-mappings/</url>
    <content><![CDATA[<h1 id="记录一次ES修改mapping"><a href="#记录一次ES修改mapping" class="headerlink" title="记录一次ES修改mapping"></a>记录一次ES修改mapping</h1><p>背景：系统会在每月前一天自动创建索引并设置索引的mapping。不知为何，没有生效。</p>
<p>所以在写入新doc时（如果index不存在es会自动创建），es自动创建的索引类型和我们预期的不相同，影响到了查询。</p>
<p>因此需要对mapping进行变更。</p>
<p>源索引</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;mapping&quot;: &#123;</span><br><span class="line">    &quot;api_usage_log&quot;: &#123;</span><br><span class="line">      &quot;properties&quot;: &#123;</span><br><span class="line">        &quot;api_key&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">          &quot;fields&quot;: &#123;</span><br><span class="line">            &quot;keyword&quot;: &#123;</span><br><span class="line">              &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">              &quot;ignore_above&quot;: 256</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;api_type&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;long&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;batch_size&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;long&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;breadcrumb_id&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">          &quot;fields&quot;: &#123;</span><br><span class="line">            &quot;keyword&quot;: &#123;</span><br><span class="line">              &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">              &quot;ignore_above&quot;: 256</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;client_ip&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">          &quot;fields&quot;: &#123;</span><br><span class="line">            &quot;keyword&quot;: &#123;</span><br><span class="line">              &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">              &quot;ignore_above&quot;: 256</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;create_time&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;long&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;duration_time&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;long&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;error_msg&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">          &quot;fields&quot;: &#123;</span><br><span class="line">            &quot;keyword&quot;: &#123;</span><br><span class="line">              &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">              &quot;ignore_above&quot;: 256</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;error_type&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;long&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;extra&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">          &quot;fields&quot;: &#123;</span><br><span class="line">            &quot;keyword&quot;: &#123;</span><br><span class="line">              &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">              &quot;ignore_above&quot;: 256</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;host_addr&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">          &quot;fields&quot;: &#123;</span><br><span class="line">            &quot;keyword&quot;: &#123;</span><br><span class="line">              &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">              &quot;ignore_above&quot;: 256</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;method&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">          &quot;fields&quot;: &#123;</span><br><span class="line">            &quot;keyword&quot;: &#123;</span><br><span class="line">              &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">              &quot;ignore_above&quot;: 256</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;refer&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">          &quot;fields&quot;: &#123;</span><br><span class="line">            &quot;keyword&quot;: &#123;</span><br><span class="line">              &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">              &quot;ignore_above&quot;: 256</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;result&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;boolean&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;system&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">          &quot;fields&quot;: &#123;</span><br><span class="line">            &quot;keyword&quot;: &#123;</span><br><span class="line">              &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">              &quot;ignore_above&quot;: 256</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;uri&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">          &quot;fields&quot;: &#123;</span><br><span class="line">            &quot;keyword&quot;: &#123;</span><br><span class="line">              &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">              &quot;ignore_above&quot;: 256</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="ES修改mapping"><a href="#ES修改mapping" class="headerlink" title="ES修改mapping"></a>ES修改mapping</h2><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.8/indices-put-mapping.html#updating-field-mappings" target="_blank" rel="noopener">修改API(版本6.8)</a></p>
<p>7.x版本的文档里没有/_doc好像</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">PUT api_usage_202006/_mapping/_doc</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"properties"</span>: &#123;</span><br><span class="line">        <span class="attr">"create_time"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"date"</span></span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>报错，不允许变更字段类型。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"error"</span>: &#123;</span><br><span class="line">    <span class="attr">"root_cause"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"remote_transport_exception"</span>,</span><br><span class="line">        <span class="attr">"reason"</span>: <span class="string">"[1584684161500788911][9.35.159.72:22017][indices:admin/mapping/put]"</span></span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"illegal_argument_exception"</span>,</span><br><span class="line">    <span class="attr">"reason"</span>: <span class="string">"mapper [create_time] of different type, current_type [long], merged_type [date]"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"status"</span>: <span class="number">400</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-put-mapping.html#updating-field-mappings" target="_blank" rel="noopener">官方文档说明</a>:</p>
<blockquote>
<p>Update the mapping of a field</p>
<p>Except for supported <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-params.html" target="_blank" rel="noopener">mapping parameters</a>, you can’t change the mapping or field type of an existing field. Changing an existing field could invalidate data that’s already indexed.</p>
<p>If you need to change the mapping of a field, create a new index with the correct mapping and <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-reindex.html" target="_blank" rel="noopener">reindex</a> your data into that index.</p>
<p>Renaming a field would invalidate data already indexed under the old field name. Instead, add an <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/alias.html" target="_blank" rel="noopener">alias</a> field to create an alternate field name.</p>
</blockquote>
<p>不能改变已经存在的字段的映射类型，改变已经存在的字段类型会使得已经被索引的数据无效。如果你需要去改变一个字段的mapping映射，创建一个新的正确mapping的index，然后重新索引你的数据到新的index中。</p>
<p>如果对已经索引的字段进行改名也会导致数据无效，可以利用<code>别名</code>来创建一个要修改的字段名。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;my_index&quot; : &#123;</span><br><span class="line">    &quot;mappings&quot; : &#123;</span><br><span class="line">      &quot;properties&quot; : &#123;</span><br><span class="line">        &quot;user_id&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;alias&quot;,</span><br><span class="line">          &quot;path&quot; : &quot;user_identifier&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;user_identifier&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>下面我们按照上述的方法操作一下吧。</p>
<h2 id="Reindex"><a href="#Reindex" class="headerlink" title="Reindex"></a>Reindex</h2><p><strong>Step1: 使用正确的mapping新建一个索引api_usage_202006_1</strong></p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">PUT api_usage_202006_1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"mappings"</span>: &#123;</span><br><span class="line">    <span class="attr">"api_usage_log"</span>: &#123;</span><br><span class="line">      <span class="attr">"properties"</span>: &#123;</span><br><span class="line">        <span class="attr">"api_key"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"api_type"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"short"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"batch_size"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"long"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"breadcrumb_id"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"client_ip"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"create_time"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"date"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"duration_time"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"long"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"error_msg"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"error_type"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"short"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"extra"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"full_method"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"host_addr"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"method"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"keyword"</span>,</span><br><span class="line">          <span class="attr">"copy_to"</span>: [</span><br><span class="line">            <span class="string">"full_method"</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"refer"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"result"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"boolean"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"system"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"uri"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"keyword"</span>,</span><br><span class="line">          <span class="attr">"copy_to"</span>: [</span><br><span class="line">            <span class="string">"full_method"</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//返回，创建成功</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"acknowledged"</span> : <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"shards_acknowledged"</span> : <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"index"</span> : <span class="string">"api_usage_202006_1"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Step2: 使用reindex API来将数据从原index重新索引到新index中。</strong></p>
<p>更多用法参考<a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.8/docs-reindex.html" target="_blank" rel="noopener">ES官方文档-Reindex API</a></p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">POST _reindex?wait_for_completion=false</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"source"</span>: &#123;</span><br><span class="line">    <span class="attr">"index"</span>: <span class="string">"api_usage_202006"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"dest"</span>: &#123;</span><br><span class="line">    <span class="attr">"index"</span>: <span class="string">"api_usage_202006_1"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//返回</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"task"</span> : <span class="string">"FOW_jYOeSMiLpioFoqWTXA:583524197"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个任务耗时很长，如果不加<code>wait_for_completion=false</code> 发出的http请求会timeout（但是任务还在执行中）加上则会返回一个taskId。可是使用<code>GET _tasks/FOW_jYOeSMiLpioFoqWTXA:583524197</code>查看。</p>
<h4 id="更多Reindex用法参数"><a href="#更多Reindex用法参数" class="headerlink" title="更多Reindex用法参数"></a>更多Reindex用法参数</h4><ul>
<li><strong>op_type</strong></li>
</ul>
<p>把<code>op_type</code>设置为create，则只在目标 index中添加不存在的doucments。如果相同的documents已经存在，则会报version confilct的错误。</p>
<blockquote>
<p>Settings op_type to create will cause _reindex to only create missing documents in the target index.<br>All existing documents will cause a version conflict。</p>
</blockquote>
<ul>
<li><strong>version_type</strong></li>
</ul>
<p>不设置<code>version_type</code>或将它设置为<code>internal</code>，Elasticsearch将会直接将文档转储到dest中，覆盖任何具有相同类型和id的document。</p>
<p>如果把<code>version_type</code>设置为<code>external</code>，则elasticsearch会从source读取<code>version</code>字段，当遇到具有相同类型和id的document，只更新newer verion。</p>
<p>会关注<code>_version</code>元属性。</p>
<ul>
<li><strong>conflicts配置</strong></li>
</ul>
<p>默认情况下，版本冲突会终止reindex过程。可以设置<code>&quot;conflicts&quot;: &quot;proceed&quot;</code>来忽略冲突，继续处理。</p>
<blockquote>
<p>By default version conflicts abort the _reindex process<br>but you can just count them by settings “conflicts”: “proceed” in the request body</p>
</blockquote>
<p>然后我们更新一下reindex请求，最终的效果是只创建不存在的，已有同样_id的记录会被忽略。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">POST _reindex?wait_for_completion=false</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"conflicts"</span>: <span class="string">"proceed"</span>,</span><br><span class="line">  <span class="attr">"source"</span>: &#123;</span><br><span class="line">    <span class="attr">"index"</span>: <span class="string">"api_usage_202006"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"dest"</span>: &#123;</span><br><span class="line">    <span class="attr">"index"</span>: <span class="string">"api_usage_202006_1"</span>,</span><br><span class="line">    <span class="attr">"op_type"</span>: <span class="string">"create"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>Reindex过程还可以对源数据进行过滤、从远程服务器进行reindex等等，但是我们暂时使用不到这些特性。</p>
<p>任务结束后，发现新索引的文档数比源索引要少很多，看起来没有完全复制过来。</p>
<img src="../images/es-change-mappings/image-20200603140340207.png" alt="image-20200603140340207" style="zoom: 50%;" />

<img src="../images/es-change-mappings/image-20200603140414658.png" alt="image-20200603140414658" style="zoom: 50%;" />



<h2 id="TASK"><a href="#TASK" class="headerlink" title="TASK"></a>TASK</h2><p>查看Tasks更多用法参考<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/tasks.html" target="_blank" rel="noopener">ES官方文档-Task API</a></p>
<h3 id="查看reindex任务"><a href="#查看reindex任务" class="headerlink" title="查看reindex任务"></a>查看reindex任务</h3><p>我们可以使用以下API查看全部在执行中的reindex任务。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET /_tasks?actions=*reindex&amp;detailed </span><br><span class="line"></span><br><span class="line"><span class="comment">//返回</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"nodes"</span> : &#123;</span><br><span class="line">    <span class="attr">"-M_3R6eYSjCAEWLWv_aZjA"</span> : &#123;</span><br><span class="line">      <span class="attr">"name"</span> : <span class="string">"1584684161500788911"</span>,</span><br><span class="line">      <span class="attr">"transport_address"</span> : <span class="string">"9.35.159.72:22017"</span>,</span><br><span class="line">      <span class="attr">"host"</span> : <span class="string">"9.35.159.72"</span>,</span><br><span class="line">      <span class="attr">"ip"</span> : <span class="string">"9.35.159.72:22017"</span>,</span><br><span class="line">      <span class="attr">"roles"</span> : [</span><br><span class="line">        <span class="string">"master"</span>,</span><br><span class="line">        <span class="string">"data"</span>,</span><br><span class="line">        <span class="string">"ingest"</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"attributes"</span> : &#123;</span><br><span class="line">        <span class="attr">"ml.machine_memory"</span> : <span class="string">"269184757760"</span>,</span><br><span class="line">        <span class="attr">"rack"</span> : <span class="string">"247855"</span>,</span><br><span class="line">        <span class="attr">"xpack.installed"</span> : <span class="string">"true"</span>,</span><br><span class="line">        <span class="attr">"set"</span> : <span class="string">"152"</span>,</span><br><span class="line">        <span class="attr">"ip"</span> : <span class="string">"9.35.159.72"</span>,</span><br><span class="line">        <span class="attr">"temperature"</span> : <span class="string">"hot"</span>,</span><br><span class="line">        <span class="attr">"ml.max_open_jobs"</span> : <span class="string">"20"</span>,</span><br><span class="line">        <span class="attr">"ml.enabled"</span> : <span class="string">"true"</span>,</span><br><span class="line">        <span class="attr">"region"</span> : <span class="string">"99"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"tasks"</span> : &#123;</span><br><span class="line">        <span class="attr">"-M_3R6eYSjCAEWLWv_aZjA:647891686"</span> : &#123;</span><br><span class="line">          <span class="attr">"node"</span> : <span class="string">"-M_3R6eYSjCAEWLWv_aZjA"</span>,</span><br><span class="line">          <span class="attr">"id"</span> : <span class="number">647891686</span>,</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"transport"</span>,</span><br><span class="line">          <span class="attr">"action"</span> : <span class="string">"indices:data/write/reindex"</span>,</span><br><span class="line">          <span class="attr">"status"</span> : &#123;</span><br><span class="line">            <span class="attr">"total"</span> : <span class="number">49109680</span>,</span><br><span class="line">            <span class="attr">"updated"</span> : <span class="number">0</span>,</span><br><span class="line">            <span class="attr">"created"</span> : <span class="number">0</span>,</span><br><span class="line">            <span class="attr">"deleted"</span> : <span class="number">0</span>,</span><br><span class="line">            <span class="attr">"batches"</span> : <span class="number">1600</span>,</span><br><span class="line">            <span class="attr">"version_conflicts"</span> : <span class="number">1599000</span>,</span><br><span class="line">            <span class="attr">"noops"</span> : <span class="number">0</span>,</span><br><span class="line">            <span class="attr">"retries"</span> : &#123;</span><br><span class="line">              <span class="attr">"bulk"</span> : <span class="number">0</span>,</span><br><span class="line">              <span class="attr">"search"</span> : <span class="number">0</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"throttled_millis"</span> : <span class="number">0</span>,</span><br><span class="line">            <span class="attr">"requests_per_second"</span> : <span class="number">-1.0</span>,</span><br><span class="line">            <span class="attr">"throttled_until_millis"</span> : <span class="number">0</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">"description"</span> : <span class="string">"reindex from [api_usage_202006] to [api_usage_202006_1]"</span>,</span><br><span class="line">          <span class="attr">"start_time_in_millis"</span> : <span class="number">1591200744421</span>,</span><br><span class="line">          <span class="attr">"running_time_in_nanos"</span> : <span class="number">72461270718</span>,</span><br><span class="line">          <span class="attr">"cancellable"</span> : <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">"headers"</span> : &#123; &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//结束返回</span></span><br><span class="line">&#123;<span class="attr">"nodes"</span>:&#123;&#125;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="查看具体任务执行情况"><a href="#查看具体任务执行情况" class="headerlink" title="查看具体任务执行情况"></a>查看具体任务执行情况</h3><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET _tasks/FOW_jYOeSMiLpioFoqWTXA:583524197</span><br><span class="line"><span class="comment">//返回</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"completed"</span> : <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"task"</span> : &#123;</span><br><span class="line">    <span class="attr">"node"</span> : <span class="string">"FOW_jYOeSMiLpioFoqWTXA"</span>,</span><br><span class="line">    <span class="attr">"id"</span> : <span class="number">583524197</span>,</span><br><span class="line">    <span class="attr">"type"</span> : <span class="string">"transport"</span>,</span><br><span class="line">    <span class="attr">"action"</span> : <span class="string">"indices:data/write/reindex"</span>,</span><br><span class="line">    <span class="attr">"status"</span> : &#123;</span><br><span class="line">      <span class="attr">"total"</span> : <span class="number">41990051</span>,</span><br><span class="line">      <span class="attr">"updated"</span> : <span class="number">0</span>,</span><br><span class="line">      <span class="attr">"created"</span> : <span class="number">1885998</span>,</span><br><span class="line">      <span class="attr">"deleted"</span> : <span class="number">0</span>,</span><br><span class="line">      <span class="attr">"batches"</span> : <span class="number">1886</span>,</span><br><span class="line">      <span class="attr">"version_conflicts"</span> : <span class="number">0</span>,</span><br><span class="line">      <span class="attr">"noops"</span> : <span class="number">0</span>,</span><br><span class="line">      <span class="attr">"retries"</span> : &#123;</span><br><span class="line">        <span class="attr">"bulk"</span> : <span class="number">0</span>,</span><br><span class="line">        <span class="attr">"search"</span> : <span class="number">0</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"throttled_millis"</span> : <span class="number">0</span>,</span><br><span class="line">      <span class="attr">"requests_per_second"</span> : <span class="number">-1.0</span>,</span><br><span class="line">      <span class="attr">"throttled_until_millis"</span> : <span class="number">0</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"description"</span> : <span class="string">"reindex from [api_usage_202006] to [api_usage_202006_1]"</span>,</span><br><span class="line">    <span class="attr">"start_time_in_millis"</span> : <span class="number">1591164911378</span>,</span><br><span class="line">    <span class="attr">"running_time_in_nanos"</span> : <span class="number">41535674884</span>,</span><br><span class="line">    <span class="attr">"cancellable"</span> : <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"headers"</span> : &#123; &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"response"</span> : &#123;</span><br><span class="line">    <span class="attr">"took"</span> : <span class="number">41516</span>,</span><br><span class="line">    <span class="attr">"timed_out"</span> : <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"total"</span> : <span class="number">41990051</span>,</span><br><span class="line">    <span class="attr">"updated"</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"created"</span> : <span class="number">1885998</span>,</span><br><span class="line">    <span class="attr">"deleted"</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"batches"</span> : <span class="number">1886</span>,</span><br><span class="line">    <span class="attr">"version_conflicts"</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"noops"</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"retries"</span> : &#123;</span><br><span class="line">      <span class="attr">"bulk"</span> : <span class="number">0</span>,</span><br><span class="line">      <span class="attr">"search"</span> : <span class="number">0</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"throttled"</span> : <span class="string">"0s"</span>,</span><br><span class="line">    <span class="attr">"throttled_millis"</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"requests_per_second"</span> : <span class="number">-1.0</span>,</span><br><span class="line">    <span class="attr">"throttled_until"</span> : <span class="string">"0s"</span>,</span><br><span class="line">    <span class="attr">"throttled_until_millis"</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"failures"</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"index"</span> : <span class="string">"api_usage_202006_1"</span>,</span><br><span class="line">        <span class="attr">"type"</span> : <span class="string">"api_usage_log"</span>,</span><br><span class="line">        <span class="attr">"id"</span> : <span class="string">"3auGbXIBiN3puyemox3_"</span>,</span><br><span class="line">        <span class="attr">"cause"</span> : &#123;</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"illegal_argument_exception"</span>,</span><br><span class="line">          <span class="attr">"reason"</span> : <span class="string">""</span><span class="string">"Document contains at least one immense term in field="</span>extra<span class="string">" (whose UTF8 encoding is longer than the max length 32766), all of which were skipped.  Please correct the analyzer to not produce such terms.  The prefix of the first immense term is: '[123, 34, 117, 114, 108, 34, 58, 34, 104, 116, 116, 112, 58, 47, 47, 101, 114, 112, 46, 111, 97, 46, 99, 111, 109, 47, 118, 50, 47, 106]...', original message: bytes can be at most 32766 in length; got 40321"</span><span class="string">""</span>,</span><br><span class="line">          <span class="attr">"caused_by"</span> : &#123;</span><br><span class="line">            <span class="attr">"type"</span> : <span class="string">"max_bytes_length_exceeded_exception"</span>,</span><br><span class="line">            <span class="attr">"reason"</span> : <span class="string">"max_bytes_length_exceeded_exception: bytes can be at most 32766 in length; got 40321"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"status"</span> : <span class="number">400</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"index"</span> : <span class="string">"api_usage_202006_1"</span>,</span><br><span class="line">        <span class="attr">"type"</span> : <span class="string">"api_usage_log"</span>,</span><br><span class="line">        <span class="attr">"id"</span> : <span class="string">"rKuGbXIBiN3puyemkBtq"</span>,</span><br><span class="line">        <span class="attr">"cause"</span> : &#123;</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"illegal_argument_exception"</span>,</span><br><span class="line">          <span class="attr">"reason"</span> : <span class="string">""</span><span class="string">"Document contains at least one immense term in field="</span>extra<span class="string">" (whose UTF8 encoding is longer than the max length 32766), all of which were skipped.  Please correct the analyzer to not produce such terms.  The prefix of the first immense term is: '[123, 34, 117, 114, 108, 34, 58, 34, 104, 116, 116, 112, 58, 47, 47, 101, 114, 112, 46, 111, 97, 46, 99, 111, 109, 47, 118, 50, 47, 106]...', original message: bytes can be at most 32766 in length; got 40273"</span><span class="string">""</span>,</span><br><span class="line">          <span class="attr">"caused_by"</span> : &#123;</span><br><span class="line">            <span class="attr">"type"</span> : <span class="string">"max_bytes_length_exceeded_exception"</span>,</span><br><span class="line">            <span class="attr">"reason"</span> : <span class="string">"max_bytes_length_exceeded_exception: bytes can be at most 32766 in length; got 40273"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"status"</span> : <span class="number">400</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用taskId查看当前的任务，其中failures表示有失败，可以看出失败的原因是某记录<code>extra</code>字段的值长度超出了32766大小。</p>
<p>我们是从text类型转到keyword类型，类型Text和Keyword之间的区别？</p>
<p>1、ES5.X版本以后，keyword支持的最大长度为32766个UTF-8字符（也就是说term精确匹配的最大支持的长度为32766个UTF-8个字符）。可以支持聚合、排序等操作。</p>
<p>2、text对字符长度没有限制。支持分词。无法精确匹配、不支持聚合、排序等操作。</p>
<p>3、可以对keyword类型设置ignore_above。作用是超过给定长度后的数据将不被索引。所以当我们检索超过ignore_above设定长度的字段时，无法返回结果。</p>
<p>注意：keyword类型超过32766长度会写入失败，超过ignore_above设定长度的数据可以写入，只是不会被索引到。</p>
<p>我们重新修改下新的index的mapping，给<code>extra</code>字段设置ignore_above=256.</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">PUT api_usage_202006_2</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"mappings"</span>: &#123;</span><br><span class="line">    <span class="attr">"api_usage_log"</span>: &#123;</span><br><span class="line">      <span class="attr">"properties"</span>: &#123;</span><br><span class="line">        ...</span><br><span class="line">        "extra": &#123;</span><br><span class="line">          "type": "keyword",</span><br><span class="line">          "ignore_above":256</span><br><span class="line">        &#125;,</span><br><span class="line">       ...</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重新执行上面的Reindex步骤，把原索引<code>api_usage_202006</code>复制到<code>api_usage_202006_2</code>。</p>
<p>查看task任务，可以看到本次执行正常啦</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET _tasks/DOoj1w0oQ-2HcSx2a_MVAg:605346355</span><br><span class="line"><span class="comment">//响应</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"completed"</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">"task"</span> : &#123;</span><br><span class="line">    <span class="attr">"node"</span> : <span class="string">"DOoj1w0oQ-2HcSx2a_MVAg"</span>,</span><br><span class="line">    <span class="attr">"id"</span> : <span class="number">605346355</span>,</span><br><span class="line">    <span class="attr">"type"</span> : <span class="string">"transport"</span>,</span><br><span class="line">    <span class="attr">"action"</span> : <span class="string">"indices:data/write/reindex"</span>,</span><br><span class="line">    <span class="attr">"status"</span> : &#123;</span><br><span class="line">      <span class="attr">"total"</span> : <span class="number">50280609</span>,</span><br><span class="line">      <span class="attr">"updated"</span> : <span class="number">0</span>,</span><br><span class="line">      <span class="attr">"created"</span> : <span class="number">18575000</span>,</span><br><span class="line">      <span class="attr">"deleted"</span> : <span class="number">0</span>,</span><br><span class="line">      <span class="attr">"batches"</span> : <span class="number">18576</span>,</span><br><span class="line">      <span class="attr">"version_conflicts"</span> : <span class="number">0</span>,</span><br><span class="line">      <span class="attr">"noops"</span> : <span class="number">0</span>,</span><br><span class="line">      <span class="attr">"retries"</span> : &#123;</span><br><span class="line">        <span class="attr">"bulk"</span> : <span class="number">0</span>,</span><br><span class="line">        <span class="attr">"search"</span> : <span class="number">0</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"throttled_millis"</span> : <span class="number">0</span>,</span><br><span class="line">      <span class="attr">"requests_per_second"</span> : <span class="number">-1.0</span>,</span><br><span class="line">      <span class="attr">"throttled_until_millis"</span> : <span class="number">0</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"description"</span> : <span class="string">"reindex from [api_usage_202006] to [api_usage_202006_2]"</span>,</span><br><span class="line">    <span class="attr">"start_time_in_millis"</span> : <span class="number">1591207610153</span>,</span><br><span class="line">    <span class="attr">"running_time_in_nanos"</span> : <span class="number">472981134093</span>,</span><br><span class="line">    <span class="attr">"cancellable"</span> : <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"headers"</span> : &#123; &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//成功</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"completed"</span> : <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"task"</span> : &#123;</span><br><span class="line">    <span class="attr">"node"</span> : <span class="string">"DOoj1w0oQ-2HcSx2a_MVAg"</span>,</span><br><span class="line">    <span class="attr">"id"</span> : <span class="number">605346355</span>,</span><br><span class="line">    <span class="attr">"type"</span> : <span class="string">"transport"</span>,</span><br><span class="line">    <span class="attr">"action"</span> : <span class="string">"indices:data/write/reindex"</span>,</span><br><span class="line">    <span class="attr">"status"</span> : &#123;</span><br><span class="line">      <span class="attr">"total"</span> : <span class="number">50280609</span>,</span><br><span class="line">      <span class="attr">"updated"</span> : <span class="number">0</span>,</span><br><span class="line">      <span class="attr">"created"</span> : <span class="number">50280609</span>,</span><br><span class="line">      <span class="attr">"deleted"</span> : <span class="number">0</span>,</span><br><span class="line">      <span class="attr">"batches"</span> : <span class="number">50281</span>,</span><br><span class="line">      <span class="attr">"version_conflicts"</span> : <span class="number">0</span>,</span><br><span class="line">      <span class="attr">"noops"</span> : <span class="number">0</span>,</span><br><span class="line">      <span class="attr">"retries"</span> : &#123;</span><br><span class="line">        <span class="attr">"bulk"</span> : <span class="number">0</span>,</span><br><span class="line">        <span class="attr">"search"</span> : <span class="number">0</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"throttled_millis"</span> : <span class="number">0</span>,</span><br><span class="line">      <span class="attr">"requests_per_second"</span> : <span class="number">-1.0</span>,</span><br><span class="line">      <span class="attr">"throttled_until_millis"</span> : <span class="number">0</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"description"</span> : <span class="string">"reindex from [api_usage_202006] to [api_usage_202006_2]"</span>,</span><br><span class="line">    <span class="attr">"start_time_in_millis"</span> : <span class="number">1591207610153</span>,</span><br><span class="line">    <span class="attr">"running_time_in_nanos"</span> : <span class="number">1430692887190</span>,</span><br><span class="line">    <span class="attr">"cancellable"</span> : <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"headers"</span> : &#123; &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"response"</span> : &#123;</span><br><span class="line">    <span class="attr">"took"</span> : <span class="number">1430692</span>,</span><br><span class="line">    <span class="attr">"timed_out"</span> : <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"total"</span> : <span class="number">50280609</span>,</span><br><span class="line">    <span class="attr">"updated"</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"created"</span> : <span class="number">50280609</span>,</span><br><span class="line">    <span class="attr">"deleted"</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"batches"</span> : <span class="number">50281</span>,</span><br><span class="line">    <span class="attr">"version_conflicts"</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"noops"</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"retries"</span> : &#123;</span><br><span class="line">      <span class="attr">"bulk"</span> : <span class="number">0</span>,</span><br><span class="line">      <span class="attr">"search"</span> : <span class="number">0</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"throttled"</span> : <span class="string">"0s"</span>,</span><br><span class="line">    <span class="attr">"throttled_millis"</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"requests_per_second"</span> : <span class="number">-1.0</span>,</span><br><span class="line">    <span class="attr">"throttled_until"</span> : <span class="string">"0s"</span>,</span><br><span class="line">    <span class="attr">"throttled_until_millis"</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"failures"</span> : [ ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="使用别名来替换原index"><a href="#使用别名来替换原index" class="headerlink" title="使用别名来替换原index"></a>使用别名来替换原index</h2><p><strong>Step3: 使用<a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.8/indices-aliases.html" target="_blank" rel="noopener">_aliases</a>给新建的index（api_usage_202006_2）创建同名别名<code>api_usage_202006</code>，同时删除源index （api_usage_202006）</strong></p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">POST /_aliases</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"actions"</span> : [</span><br><span class="line">        &#123; <span class="attr">"add"</span>:  &#123; <span class="attr">"index"</span>: <span class="string">"api_usage_202006_2"</span>, <span class="attr">"alias"</span>: <span class="string">"api_usage_202006"</span> &#125; &#125;,</span><br><span class="line">        &#123; <span class="attr">"remove_index"</span>: &#123; <span class="attr">"index"</span>: <span class="string">"api_usage_202006"</span> &#125; &#125;  </span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//actions 中的多条命令是原子性的，所以可以做到无缝切换，不必担心切换过程中会存在访问不到的时候。</span></span><br></pre></td></tr></table></figure>

<p>检查</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">GET api_usage_202006</span><br><span class="line"><span class="comment">//结果： 还是可以查到结果，只不过返回的索引是</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"api_usage_202006_2"</span> : &#123;</span><br><span class="line">    <span class="attr">"aliases"</span> : &#123;</span><br><span class="line">      <span class="attr">"api_usage_202006"</span> : &#123; &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    "mappings" : &#123;...&#125;,</span><br><span class="line">    "settings" : &#123;...&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h2><p>由程序提前创建mapping的这种方式不是很可靠，如果程序出现问题还是会导致这种情况。</p>
<p>更优的方式是使用预定义的模板<a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.8/indices-templates.html" target="_blank" rel="noopener"><code>index template</code></a>进行创建，这样当未指定mappings创建的index也是我们期望的Mapping结构。</p>
<p>模板包括settings和mappings，可以通过pattern匹配的方式使得多个索引重用一个模板。</p>
 <figure class="highlight"><table><tr><td class="code"><pre><span class="line">PUT _template/api_usage_template</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"order"</span> : <span class="number">11</span>,  <span class="comment">//设置优先级，多个模版同时匹配时，order越大，优先匹配。</span></span><br><span class="line">  <span class="attr">"index_patterns"</span>: [<span class="string">"api_usage*"</span>],<span class="comment">//匹配的索引名</span></span><br><span class="line">  <span class="attr">"settings"</span> : &#123;</span><br><span class="line">      <span class="attr">"index"</span> : &#123;</span><br><span class="line">        <span class="attr">"number_of_replicas"</span> : <span class="string">"0"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  <span class="attr">"mappings"</span>: &#123;</span><br><span class="line">    <span class="attr">"api_usage_log"</span>: &#123;</span><br><span class="line">      <span class="attr">"properties"</span>: &#123;</span><br><span class="line">        <span class="attr">"api_key"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        ...</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>后续使用默认设置新建的index（名称开头为api_usage*）都会应用上述的设置。</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 没有指定mappings, 新建index</span></span><br><span class="line">PUT api_usage_test </span><br><span class="line"><span class="comment">// 查看新建的index</span></span><br><span class="line">GET api_usage_test</span><br><span class="line"><span class="comment">//返回</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"api_usage_test"</span> : &#123;</span><br><span class="line">    <span class="attr">"aliases"</span> : &#123; &#125;,</span><br><span class="line">    <span class="attr">"mappings"</span> : &#123;</span><br><span class="line">      <span class="attr">"api_usage_log"</span> : &#123;</span><br><span class="line">        <span class="attr">"properties"</span> : &#123;</span><br><span class="line">          <span class="attr">"api_key"</span> : &#123;</span><br><span class="line">            <span class="attr">"type"</span> : <span class="string">"keyword"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          ...</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    "settings" : &#123;</span><br><span class="line">      "index" : &#123;</span><br><span class="line">        "creation_date" : "1593076529529",</span><br><span class="line">        "number_of_shards" : "5",</span><br><span class="line">        "number_of_replicas" : "0",</span><br><span class="line">        "uuid" : "iwAAdMnnRt-188eLokslHQ",</span><br><span class="line">        "version" : &#123;</span><br><span class="line">          "created" : "6080299"</span><br><span class="line">        &#125;,</span><br><span class="line">        "provided_name" : "api_usage_test"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>修改mapping的步骤：</p>
<p>Step1: 创建一个新的new_index，使用正确的mapping</p>
<p>Step2: 使用<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-reindex.html" target="_blank" rel="noopener">reindex</a>API把源index的数据拷贝到new_index中</p>
<p>Step3: 对new_index添加一个源index同名的别名</p>
<p>Step4: 删除源index。使用源index名的查找都会指向新的索引new_index，并且以正确的mapping结构进行检索。</p>
<p>参考：</p>
<p><a href="https://blog.csdn.net/u013613428/article/details/78227277" target="_blank" rel="noopener">https://blog.csdn.net/u013613428/article/details/78227277</a></p>
<p><a href="https://javasgl.github.io/use-alias-migrate-index/" target="_blank" rel="noopener">https://javasgl.github.io/use-alias-migrate-index/</a></p>
<p><a href="http://doc.codingdict.com/elasticsearch/90/" target="_blank" rel="noopener">http://doc.codingdict.com/elasticsearch/90/</a></p>
]]></content>
      <categories>
        <category>ES</category>
      </categories>
      <tags>
        <tag>ElasticSearch</tag>
      </tags>
  </entry>
  <entry>
    <title>docker-常用操作</title>
    <url>/2020/02/22/docker-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/</url>
    <content><![CDATA[<h1 id="docker"><a href="#docker" class="headerlink" title="docker"></a>docker</h1><ul>
<li>查看</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker info &#x2F;&#x2F;Display system-wide information</span><br></pre></td></tr></table></figure>



<ul>
<li>登陆</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker login &#x2F;&#x2F;登陆docker hub ID, 用于push和pull自定义镜像</span><br></pre></td></tr></table></figure>



<h1 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h1><ul>
<li>拉取镜像</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker pull elasticsearch:6.7.0</span><br></pre></td></tr></table></figure>



<ul>
<li>运行容器</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker run </span><br><span class="line"></span><br><span class="line">-e ES_JAVA_OPTS="-Xms256m -Xmx256m"  //环境变量</span><br><span class="line"></span><br><span class="line">-d  //守护进程运行</span><br><span class="line"></span><br><span class="line">-p 9200:9200 -p 9300:9300  //端口映射</span><br><span class="line"></span><br><span class="line">-v /data/mnt/elasticsearch/config/master.yml:/usr/share/elasticsearch/config/elasticsearch.yml //将host机器的目录mount到container中。</span><br><span class="line"></span><br><span class="line">-v /data/mnt/elasticsearch/master:/usr/share/elasticsearch/data //https://www.jianshu.com/p/ef0f24fd0674</span><br><span class="line"></span><br><span class="line">--name es-master  //容器命名，不允许重名。</span><br><span class="line"></span><br><span class="line">elasticsearch:6.7.0 //镜像</span><br></pre></td></tr></table></figure>

 <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker run </span><br><span class="line"></span><br><span class="line">--link es-master:elasticsearch </span><br><span class="line"></span><br><span class="line">-p 5601:5601</span><br><span class="line"></span><br><span class="line">--name kibana </span><br><span class="line"></span><br><span class="line">-d </span><br><span class="line"></span><br><span class="line">kibana:6.7.0</span><br></pre></td></tr></table></figure>



<ul>
<li>查看运行中的容器</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker ps </span><br><span class="line"></span><br><span class="line">docker container ls</span><br></pre></td></tr></table></figure>



<ul>
<li>查看所有容器，包括启动失败、停止的。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker ps -a</span><br></pre></td></tr></table></figure>



<ul>
<li>查看某个容器的日志。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker logs [--tail 10] &#123;id&#x2F;name&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>启动容器</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker start &#123;id&#x2F;name&#125;</span><br></pre></td></tr></table></figure>

<p>-i:以 交互模式启动 <a href="https://blog.csdn.net/michel4liu/article/details/80857995" target="_blank" rel="noopener">交互模式不懂点我</a>. (docker start -i {id/name}, 本会话内运行容器，关闭会话会停止容器)</p>
<p>-t:以 附加进程方式启动 <a href="https://blog.csdn.net/michel4liu/article/details/80878686" target="_blank" rel="noopener">附加进程不懂的点我</a></p>
<ul>
<li>暂停容器、恢复容器</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker pause &#123;id&#x2F;name&#125;</span><br><span class="line"></span><br><span class="line">docker unpause &#123;id&#x2F;name&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>删除容器</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker container rm &#123;id&#x2F;name&#125;</span><br><span class="line">docker container rm $(docker container ls -a -q)  &#x2F;&#x2F;删除所有容器</span><br></pre></td></tr></table></figure>



<ul>
<li>以命令行交互的方式 进入某个在运行的容器</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker exec -it &#123;container-id&#x2F;name&#125; bash</span><br><span class="line"></span><br><span class="line">docker exec -it &#123;container-id&#x2F;name&#125; sh</span><br></pre></td></tr></table></figure>

<p>不建议使用docker attach （关闭会话会停止容器） </p>
<ul>
<li>退出容器：exit</li>
</ul>
<ul>
<li>获取容器的PID</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker inspect --format &quot;&#123;&#123;.State.Pid&#125;&#125;&quot; &#123;container-id&#x2F;name&#125;</span><br><span class="line">docker top &#123;container-id&#x2F;name&#125; &#x2F;&#x2F;查看容器进程</span><br></pre></td></tr></table></figure>



<h1 id="镜像"><a href="#镜像" class="headerlink" title="镜像"></a>镜像</h1><ul>
<li><p>查看镜像</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker images</span><br><span class="line">docker image ls -a</span><br><span class="line">docker image inspect app:v1</span><br><span class="line">docker images -f dangling&#x3D;false &#x2F;&#x2F; -f,--filter筛选</span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>构建镜像</p>
<p>在Dockerfile所在目录下执行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker build </span><br><span class="line">--network host   &#x2F;&#x2F;使用本机网络</span><br><span class="line">-t app:v1        &#x2F;&#x2F;生成的镜像app,版本为v1</span><br><span class="line">.                &#x2F;&#x2F;build上下文为当前目录</span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>推送自定义镜像到远程仓库</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker push &lt;username&gt;&#x2F;&lt;repository&gt;:&lt;tag&gt;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>删除镜像</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker image rm app:v1</span><br><span class="line">docker rmi app:v1</span><br><span class="line">docker image prune &#x2F;&#x2F;删除所有悬空镜像dangling images</span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>新增tag</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker image tag app:v1 app:v2</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h1 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h1><ul>
<li>设置环境变量：</li>
</ul>
<p>1）通过dockerfile里的ENV命令设置 （跟随镜像）</p>
<p>2）通过<code>docker run --env &lt;key&gt;=&lt;value&gt;</code> 时指定或修改启动后的环境变量 （当前运行的容器生效）</p>
<ul>
<li>查看环境变量：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker inspect</span><br><span class="line">docker exec -it &lt;CONTAINER-NAME&gt; OR &lt;CONTAINER-ID&gt; env</span><br></pre></td></tr></table></figure>



<h1 id="进入STOP的容器"><a href="#进入STOP的容器" class="headerlink" title="进入STOP的容器"></a>进入STOP的容器</h1><p>找到想要进入的容器id, 假设是 837ffa1d4</p>
<p>保存”案发现场”为镜像</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker commit 837ffa1d4 user&#x2F;temp</span><br><span class="line">docker run -it user&#x2F;temp sh &#x2F;&#x2F;启动进入新容器</span><br></pre></td></tr></table></figure>







]]></content>
      <categories>
        <category>docker</category>
      </categories>
      <tags>
        <tag>docker</tag>
        <tag>cmd</tag>
      </tags>
  </entry>
</search>
